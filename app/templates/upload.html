{% extends "base.html" %}

{% block title %}룰팩 업로드{% endblock %}

{% block content %}
    <h2>룰팩 XML 업로드 및 DB 저장</h2>
    <p>룰팩들이 들어있는 폴더를 선택하면, 하위 폴더를 포함한 모든 'externalmetadata.xml' 파일이 아래 목록에 나타납니다.</p>
    
    <form method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="xml_files">룰팩들이 들어있는 폴더 선택:</label>
            <input type="file" id="xml_files" name="xml_files" webkitdirectory directory multiple required>
        </div>

        <div id="file-list-area" style="margin-top: 15px;">
            <h4>선택된 'externalmetadata.xml' 파일 목록:</h4>
            <div id="file-count" style="font-weight: bold; margin-bottom: 10px;">파일 0개</div>
            <ul id="file-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px;">
                <li style="color: #888;">폴더를 선택해주세요.</li>
            </ul>
        </div>
        
        <button type="submit" style="margin-top: 15px;">업로드 및 DB 저장</button>
    </form>

    <script>
        // 파일 입력(input) 엘리먼트를 찾습니다.
        const fileInput = document.getElementById('xml_files');
        // 파일 목록을 보여줄 ul 엘리먼트를 찾습니다.
        const fileListUl = document.getElementById('file-list');
        // 파일 개수를 보여줄 div 엘리먼트를 찾습니다.
        const fileCountDiv = document.getElementById('file-count');

        // 파일 입력에 변경이 생겼을 때(폴더가 선택되었을 때) 실행할 함수를 등록합니다.
        fileInput.addEventListener('change', function(event) {
            // 기존 목록을 비웁니다.
            fileListUl.innerHTML = '';
            
            // 사용자가 선택한 파일들의 목록을 가져옵니다.
            const files = event.target.files;
            let externalMetadataFilesCount = 0;

            // 모든 파일을 순회하면서
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // 파일 이름이 'externalmetadata.xml'로 끝나는지 확인합니다.
                if (file.name.endsWith('externalmetadata.xml')) {
                    externalMetadataFilesCount++;
                    // 새로운 리스트 아이템(li)을 만듭니다.
                    const listItem = document.createElement('li');
                    // 리스트 아이템의 내용으로 파일 경로를 넣습니다.
                    listItem.textContent = file.webkitRelativePath || file.name;
                    // 목록에 추가합니다.
                    fileListUl.appendChild(listItem);
                }
            }

            // 최종 파일 개수를 업데이트합니다.
            fileCountDiv.textContent = `파일 ${externalMetadataFilesCount}개`;

            if (externalMetadataFilesCount === 0) {
                const listItem = document.createElement('li');
                listItem.textContent = '선택한 폴더에 externalmetadata.xml 파일이 없습니다.';
                listItem.style.color = 'red';
                fileListUl.appendChild(listItem);
            }
        });
    </script>
{% endblock %}